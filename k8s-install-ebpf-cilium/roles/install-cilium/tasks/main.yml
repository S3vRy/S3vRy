---
# Cilium installation

- name: Download Cilium CLI
  ansible.builtin.get_url:
    url: "https://github.com/cilium/cilium-cli/releases/download/v{{ cilium_cli_version }}/cilium-linux-amd64.tar.gz"
    dest: /tmp/cilium-linux-amd64.tar.gz
    mode: "0644"

- name: Download Cilium CLI checksum
  ansible.builtin.get_url:
    url: "https://github.com/cilium/cilium-cli/releases/download/v{{ cilium_cli_version }}/cilium-linux-amd64.tar.gz.sha256sum"
    dest: /tmp/cilium-linux-amd64.tar.gz.sha256sum
    mode: "0644"

- name: Verify checksum
  ansible.builtin.command:
    cmd: sha256sum --check /tmp/cilium-linux-amd64.tar.gz.sha256sum
  args:
    chdir: /tmp

- name: Extract Cilium CLI
  ansible.builtin.unarchive:
    src: /tmp/cilium-linux-amd64.tar.gz
    dest: /usr/local/bin
    remote_src: true
    creates: /usr/local/bin/cilium

- name: Remove archives
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/cilium-linux-amd64.tar.gz
    - /tmp/cilium-linux-amd64.tar.gz.sha256sum

- name: Verify Cilium CLI installation
  ansible.builtin.command:
    cmd: cilium version --client
  register: cilium_cli_version_check
  changed_when: false

- name: Install Cilium
  ansible.builtin.shell: |
    cilium install \
      --version {{ cilium_version }} \
      --set ipam.mode=kubernetes \
      --set kubeProxyReplacement=true \
      --set k8sServiceHost={{ cilium_k8s_service_host }} \
      --set k8sServicePort={{ cilium_k8s_service_port }} \
      --set gatewayAPI.enabled=true \
      --set gatewayAPI.secretsNamespace.create=true \
      --set l2announcements.enabled=true \
      --set externalIPs.enabled=true \
      --set hubble.relay.enabled=true \
      --set hubble.ui.enabled=true
  args:
    creates: /tmp/cilium_installed
  register: cilium_install

- name: Create installation marker
  ansible.builtin.file:
    path: /tmp/cilium_installed
    state: touch
  when: cilium_install.changed

- name: Wait for Cilium readiness
  ansible.builtin.command:
    cmd: cilium status --wait
  register: cilium_status
  until: cilium_status.rc == 0
  retries: 30
  delay: 10

- name: Check Cilium status
  ansible.builtin.command:
    cmd: cilium version
  register: cilium_version_check
  changed_when: false

- name: Display Cilium version
  ansible.builtin.debug:
    msg: "{{ cilium_version_check.stdout_lines }}"
