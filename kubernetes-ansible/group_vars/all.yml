---
# ============================================================================
# Global Configuration for All Nodes
# ============================================================================
# This file uses variables from cluster-config.yml
# Edit cluster-config.yml to change these values
# ============================================================================

# Include cluster configuration
# Variables from cluster-config.yml are automatically loaded via vars_files in site.yml

# ----------------------------------------------------------------------------
# Network Configuration (derived from cluster-config.yml)
# ----------------------------------------------------------------------------
# These are computed from masters list in cluster-config.yml
node_ips: "{{ masters | map(attribute='ansible_host') | map('regex_replace', '^(.+)$', '\\1/32') | list }}"

# VPN configuration (from cluster-config.yml)
# vpn_server_ip and vpn_network are loaded from cluster-config.yml

# ----------------------------------------------------------------------------
# Security Configuration
# ----------------------------------------------------------------------------
# SSH allowed IPs - includes VPN network, VPN server, and master node IPs
# Master node IPs are automatically added from masters list
# Custom IPs from cluster-config.yml are merged here
ssh_allowed_ips: "{{ (ssh_allowed_ips | default([])) + (masters | map(attribute='ansible_host') | map('regex_replace', '^(.+)$', '\\1/32') | list) + ([vpn_network] if vpn_network is defined else []) + ([vpn_server_ip + '/32'] if vpn_server_ip is defined else []) }}"

# Allowed IPs for SSH and full access
allowed_ips: "{{ ssh_allowed_ips + [pod_network_cidr, service_network_cidr] }}"

# SSH configuration
ssh_min_version: "9.6"
ssh_permit_root_login: "yes"
ssh_password_authentication: "no"
ssh_allow_users: "root"

# Firewall configuration
firewall_enabled: "{{ firewall_enabled | default(true) }}"
firewall_log_drops: "{{ firewall_log_drops | default(true) }}"
firewall_default_policy: "{{ firewall_default_policy | default('deny') }}"

# Public ports (from cluster-config.yml)
# public_ports is loaded from cluster-config.yml

# ICMP (ping) allowed sources
icmp_allowed_sources: "{{ node_ips + [vpn_network, vpn_server_ip + '/32', pod_network_cidr, service_network_cidr] }}"

# DNS allowed sources
dns_allowed_sources: "{{ icmp_allowed_sources }}"

# ----------------------------------------------------------------------------
# Kubernetes Prerequisites
# ----------------------------------------------------------------------------
# Kubernetes prerequisites packages
k8s_required_packages:
  - ipvsadm
  - ipset
  - open-iscsi
  - nfs-common
  - jq
  - socat
  - conntrack
  - curl
  - wget
  - lsof
  - htop
  - tmux
  - python3-pip
  - ca-certificates
  - fail2ban
  - ufw
  - auditd
  - iproute2
  - net-tools
  - unattended-upgrades

# Kernel modules for Kubernetes IPVS
k8s_kernel_modules:
  - overlay
  - br_netfilter
  - nf_conntrack
  - ip_vs
  - ip_vs_rr
  - ip_vs_wrr
  - ip_vs_sh

# ----------------------------------------------------------------------------
# System Configuration
# ----------------------------------------------------------------------------
# Sysctl settings for Kubernetes
k8s_sysctl_settings:
  net.ipv4.ip_forward: 1
  net.ipv6.conf.all.forwarding: 1
  net.bridge.bridge-nf-call-iptables: 1
  net.bridge.bridge-nf-call-ip6tables: 1
  net.ipv4.ip_nonlocal_bind: 1
  # nf_conntrack_max: Important for IPVS and connection tracking
  # Required for tracking network connections between pods
  # Recommended: 300,000+ for production clusters
  # Set reasonable value for stable operation
  net.netfilter.nf_conntrack_max: 500000
  net.core.somaxconn: 32768
  net.ipv4.tcp_max_syn_backlog: 8192
  net.core.netdev_max_backlog: 16384
  net.netfilter.nf_conntrack_tcp_timeout_established: 86400
  # Kernel protection settings required by protectKernelDefaults
  kernel.panic_on_oops: 1
  vm.overcommit_memory: 1
  kernel.panic: 10

# Fail2ban configuration
fail2ban_enabled: "{{ fail2ban_configuration.enabled | default(true) }}"
fail2ban_maxretry: "{{ fail2ban_configuration.maxretry | default(3) }}"
fail2ban_bantime: "{{ fail2ban_configuration.bantime | default(3600) }}"
fail2ban_findtime: "{{ fail2ban_configuration.findtime | default(600) }}"

# Unattended upgrades
unattended_upgrades_enabled: "{{ unattended_upgrades.enabled | default(true) }}"
unattended_upgrades_auto_reboot: "{{ unattended_upgrades.auto_reboot | default(false) }}"
unattended_upgrades_mail: "{{ unattended_upgrades.mail | default(false) }}"

# System configuration (from cluster-config.yml)
# timezone and locale are loaded from cluster-config.yml

# Auditd configuration
auditd_enabled: "{{ auditd.enabled | default(true) }}"

# Logging
ansible_log_path: "./ansible.log"

# ----------------------------------------------------------------------------
# Kubernetes Configuration
# ----------------------------------------------------------------------------
# Kubernetes versions (from cluster-config.yml)
# k8s_version is loaded from cluster-config.yml
k8s_version_full: "v{{ k8s_version }}"

# Container runtime
containerd_version: "{{ containerd_version | default('2.1.3') }}"
containerd_socket: "/run/containerd/containerd.sock"

# CNI (from cluster-config.yml)
# cilium_version is loaded from cluster-config.yml

# Network configuration (from cluster-config.yml)
# pod_network_cidr and service_network_cidr are loaded from cluster-config.yml

# Control Plane (from cluster-config.yml)
# control_plane_endpoint and kube_vip_vip are loaded from cluster-config.yml

# kube-vip configuration (from cluster-config.yml)
# kube_vip_version, kube_vip_mode, kube_vip_interface are loaded from cluster-config.yml

# Helm (from cluster-config.yml)
# helm_version is loaded from cluster-config.yml

# Kubernetes repository
k8s_repo_url: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/"
k8s_repo_key_url: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/Release.key"

# kube-proxy mode (from cluster-config.yml)
# kube_proxy_mode is loaded from cluster-config.yml
